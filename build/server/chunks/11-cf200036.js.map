{"version":3,"file":"11-cf200036.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/(app)/friends/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/11.js"],"sourcesContent":["import { d as db } from \"../../../../chunks/database.js\";\nimport { f as fail } from \"../../../../chunks/index.js\";\nconst load = async ({ request, locals }) => {\n  const userId = locals.user.id;\n  const userWithFriends = await db.user.findUnique({\n    where: { id: userId },\n    include: {\n      friendsAsUser1: {\n        include: {\n          user2: true\n        }\n      },\n      friendsAsUser2: {\n        include: {\n          user1: true\n        }\n      }\n    }\n  });\n  let friends;\n  if (userWithFriends != null) {\n    friends = [\n      ...userWithFriends.friendsAsUser1.map((friend) => friend.user2),\n      ...userWithFriends.friendsAsUser2.map((friend) => friend.user1)\n    ];\n  }\n  const friendRequests = await db.friendRequest.findMany({\n    where: {\n      OR: [\n        { fromId: userId, status: \"pending\" },\n        { toId: userId, status: \"pending\" }\n      ]\n    },\n    include: {\n      from: true,\n      // Include the details of the user who sent the request\n      to: true\n      // Include the details of the user to whom the request was sent\n    }\n  });\n  return {\n    friendRequests,\n    friends,\n    userId\n    // Include the friends array in the returned props\n  };\n};\nconst actions = {\n  friendRequest: async ({ request, locals }) => {\n    try {\n      const formData = Object.fromEntries(await request.formData());\n      const { userName } = formData;\n      console.log(userName);\n      const userTo = await db.user.findUnique({\n        where: {\n          username: String(userName)\n        }\n      });\n      if (!userTo) {\n        return fail(404, { error: { message: \"User not found\" } });\n      }\n      const userFromId = locals.user.id;\n      if (userTo.id == userFromId) {\n        return fail(404, {\n          error: { message: \"You cannot send a friend request to yourself\" }\n        });\n      }\n      const friendRequest = await db.friendRequest.create({\n        data: {\n          fromId: userFromId,\n          toId: userTo.id\n        }\n      });\n      const from = await db.user.findUnique({ where: { id: userFromId } });\n      const to = userTo.id;\n      const message = from?.username + \" has sent you a friend request. Go to your friends page to accept.\";\n      await db.notification.create({\n        data: {\n          content: message,\n          receiverId: to,\n          senderName: from?.username\n        }\n      });\n      return {\n        body: {\n          userName: userTo.username,\n          friendRequest: friendRequest.id\n        }\n      };\n    } catch (err) {\n      console.error(err);\n      return fail(500, { error: { message: \"Internal Server Error\" } });\n    }\n  },\n  accept: async ({ request, locals }) => {\n    try {\n      const userId = locals.user.id;\n      const formData = Object.fromEntries(await request.formData());\n      const { requestId } = formData;\n      const friendRequest = await db.friendRequest.findUnique({\n        where: { id: Number(requestId) },\n        include: { from: true, to: true }\n      });\n      if (!friendRequest) {\n        return fail(404, { error: { message: \"Friend request not found\" } });\n      }\n      const usernames = await db.user.findMany({\n        where: {\n          id: {\n            in: [friendRequest.fromId, friendRequest.toId]\n          }\n        }\n      });\n      await db.$transaction([\n        db.friendRequest.update({\n          where: { id: Number(requestId) },\n          data: { status: \"accepted\", acceptedAt: /* @__PURE__ */ new Date() }\n        }),\n        db.friend.create({\n          data: {\n            userId1: friendRequest.fromId,\n            userId2: friendRequest.toId\n          }\n        })\n      ]);\n      const name = usernames[0].username + \"â€Ž\" + usernames[1].username;\n      console.log(name);\n      await db.room.create({\n        data: {\n          name: \"DirectMessage\",\n          // Specify the room name\n          users: {\n            connect: [\n              { id: friendRequest.from.id },\n              { id: friendRequest.to.id }\n            ]\n          },\n          Chatroom: false\n        }\n      });\n      return { body: { message: \"Friend request accepted\" } };\n    } catch (err) {\n      console.error(err);\n      return fail(500, { error: { message: \"Internal Server Error\" } });\n    }\n  },\n  removeFriend: async ({ request, locals }) => {\n    try {\n      const userId = locals.user.id;\n      const data = await request.formData();\n      const friendIDTemp = data.get(\"friendID\");\n      if (!friendIDTemp) {\n        throw new Error(\"No friend ID provided.\");\n      }\n      const friendID = +friendIDTemp;\n      await db.friend.deleteMany({\n        where: {\n          OR: [\n            {\n              userId1: friendID,\n              userId2: userId\n            },\n            {\n              userId1: userId,\n              userId2: friendID\n            }\n          ]\n        }\n      });\n      const roomsToDelete = await db.room.findMany({\n        where: {\n          AND: [\n            {\n              OR: [\n                {\n                  users: {\n                    some: {\n                      id: friendID\n                    }\n                  }\n                },\n                {\n                  users: {\n                    some: {\n                      id: userId\n                    }\n                  }\n                }\n              ]\n            },\n            {\n              Chatroom: false\n            }\n          ]\n        },\n        include: {\n          users: true\n        }\n      });\n      for (const room of roomsToDelete) {\n        console.log(room);\n        const userIds = room.users.map((user) => user.id);\n        await db.room.update({\n          where: { id: room.id },\n          data: {\n            users: {\n              disconnect: userIds.map((id) => ({ id }))\n            }\n          }\n        });\n        await db.message.deleteMany({\n          where: {\n            roomId: room.id\n          }\n        });\n        await db.room.delete({\n          where: { id: room.id }\n        });\n      }\n      return { body: { message: \"Friend request accepted\" } };\n    } catch (err) {\n      console.error(err);\n      return fail(500, { error: { message: \"Internal Server Error\" } });\n    }\n  }\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/(app)/friends/_page.server.ts.js';\n\nexport const index = 11;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/(app)/friends/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/(app)/friends/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/11.687b08bf.js\",\"_app/immutable/chunks/index.229400e6.js\",\"_app/immutable/chunks/forms.4c325e09.js\",\"_app/immutable/chunks/parse.bee59afc.js\",\"_app/immutable/chunks/singletons.dd9c9a0a.js\",\"_app/immutable/chunks/navigation.71f60e69.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}